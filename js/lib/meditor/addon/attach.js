"use strict";define(["lib/layer/base","css!./attach"],function(){function t(t,a){for(var e,n=0;e=t[n++];)if("image"!==r||/image/.test(e.type)){var i=a.uploadFile.length,l=new s(a.uploadUrl||ME.uploadUrl);a.uploadFile.push({name:e.name,progress:"0%",url:""}),l.field(r,e).onProgress(function(t){a.uploadFile[i].progress=t+"%"}).onEnd(function(t){a.uploadFile[i].url=t.data.url}).start()}}function a(t,a){var e=new XMLHttpRequest,s=t.manageUrl||ME.manageUrl;s+=/\?/.test(s)?"&type="+r:"?type="+r,s+="&t="+Math.random(),e.open("GET",s,!0),e.onreadystatechange=function(){if(4===this.readyState&&200===this.status&&""!==this.responseText){var t=this.responseText;try{t=JSON.parse(t)}catch(e){}a(t)}else 200!==this.status&&this.responseText&&console.error(this.responseText)},e.send()}function e(e,s){l=!0;var n=yua(e).offset(),i=layer.open({type:7,menubar:!1,shade:!1,offset:[n.top+37],tab:2,attach:"",attachAlt:"",uploadFile:[],attachList:[],$switch:function(t){var e=yua.vmodels[i];e.tab=t,3===t&&(e.attachList.clear(),o[r].length?e.attachList=o[r]:a(s,function(t){t&&(o[r]=t.data.list.map(function(t){return t.thumb="image"===r?'<img src="'+t.url+'"/>':'<em class="attac-icon">&#xe603;</em>',t}),e.attachList=t.data.list)}))},$select:yua.noop,$change:yua.noop,$insert:function(t){var a=("image"===r?"!":"")+"["+t.name+"]("+t.url+")";ME.insert(s.$editor,a)},$confirm:function(){var t=yua.vmodels[i];if(!t.img||!t.imgAlt)return layer.alert("描述和地址不能为空");var a="!["+t.imgAlt+"]("+t.img+")";ME.insert(s.$editor,a),t.no()},success:function(a){var e=yua.vmodels[a],s=document.body.querySelector("#meditor-attch");e.no=function(){layer.close(a),l=!1},e.$select=function(){var t=document.createEvent("MouseEvent");t.initEvent("click",!1,!1),s.dispatchEvent(t)},e.$change=function(){t(this.files,e)}},content:c()})}var s=function(t){this.url=t||"",this.init()};s.prototype={init:function(){return this.xhr=new XMLHttpRequest,this.form=new FormData,this},field:function(t,a){if("object"==typeof t)for(var e in t)this.form.append(e,t[e]);else this.form.append(t,a);return this},start:function(){var t=this;this.xhr.open("POST",this.url,!0);Date.now();this.xhr.upload.addEventListener("progress",function(a){if(a.lengthComputable&&t.progress){var e=Math.round(100*a.loaded/a.total);t.progress(e)}},!1),this.xhr.onreadystatechange=function(){if(4===t.xhr.readyState)if(t.xhr.status>=200&&t.xhr.status<205){var a=t.xhr.responseText;try{a=JSON.parse(a)}catch(e){}t.end&&t.end(a)}else console.error(t.xhr)},this.xhr.send(this.form)},onProgress:function(t){return this.progress=t,this},onEnd:function(t){return this.end=t,this}};var n=function(t){t.uploadUrl||ME.uploadUrl||console.error("使用附件上传,必须先设置uploadUrl;\n可以给vm增加uploadUrl属性,也可以通过ME.uploadUrl设置"),t.manageUrl||ME.manageUrl||console.error("使用附件管理功能,必须先设置manageUrl;\n可以给vm增加manageUrl属性,也可以通过ME.manageUrl设置"),t.$editor.addEventListener("paste",function(a){var e=a.clipboardData.getData("text/plain").trim(),n=a.clipboardData.getData("text/html").trim();if(!e&&!n){if(a.clipboardData.items){for(var i,l=a.clipboardData.items,r=(l.length,null),o=0;i=l[o++];)i.type.indexOf("image")>-1&&(r=i.getAsFile());if(null!==r){var c=new s(t.uploadUrl||ME.uploadUrl);c.field("image",r).onEnd(function(a){ME.insert(t.$editor,"![截图]("+a.data.url+")")}).start()}}a.preventDefault()}})},i={image:["远程图片","图片管理","图片描述","图片地址"],file:["远程附件","附件管理","附件描述","附件地址"]},l=!1,r="image",o={image:[],file:[]},c=function(){return'<div class="do-meditor-attach meditor-font"><dl class="attach-wrap"><dt class="tab-box"><span class="item" :class="active:tab === 1" :click="$switch(1)">'+i[r][0]+'</span><span class="item" :class="active:tab === 2" :click="$switch(2)">本地上传</span><span class="item" :class="active:tab === 3" :click="$switch(3)">'+i[r][1]+'</span><a href="javascript:;" :click="no" class="action-close def-font"></a></dt><dt class="cont-box"><div class="remote" :visible="tab === 1"><section class="section"><span class="label">'+i[r][2]+'</span><input class="input" :duplex="attachAlt" /></section><section class="section"><span class="label">'+i[r][3]+'</span><input class="input" :duplex="attach" /></section><section class="section"><a href="javascript:;" class="submit" :click="$confirm">确定</a></section></div><div class="local" :visible="tab === 2"><div class="select-file"><input id="meditor-attch" multiple :change="$change" type="file" class="hide" /><span class="file" :click="$select">选择文件</span></div><ul class="upload-box"><li class="tr thead"><span class="td name">文件名</span><span class="td progress">上传进度</span><span class="td option">操作</span></li><li class="tr" :repeat="uploadFile"><span class="td name" :text="el.name"></span><span class="td progress" :text="el.progress"></span><span class="td option"><a href="javascript:;" :click="$insert(el)">插入</a></span></li></ul></div><ul class="manager" :visible="tab === 3"><li class="item" :repeat="attachList" :click="$insert(el)"><span class="thumb" :html="el.thumb"></span><p class="name" :text="el.name"></p></li></ul></dt></dl></div>'};return ME.addon.image=function(t,a){l||(r="image",e(t,a))},ME.addon.file=function(t,a){l||(r="file",e(t,a))},n});