"use strict";var log=console.log;define(["yua","lib/prism/main","lib/marked","css!./skin/main"],function(e){function t(e){return new RegExp(e+"\\s?=\\s?[\"']?([^\"']*)[\"']?","i")}function n(e){var t="";return t=["br","hr","img"].indexOf(e)>-1?"<"+e+"([^>]*)\\/?>":"<"+e+"([^>]*)>([\\s\\S]*?)<\\/"+e+">",new RegExp(t,"gi")}function r(e){e=decodeURIComponent(e).replace(/\t/g,"    ").replace(/<meta [^>]*>/,"");for(var t in o){var r=o[t],i=n(t);if("blockquote"===t)for(;e.match(i);)e=e.replace(i,r);else e=e.replace(i,r);"em"===t&&(i=n("i"),e=e.replace(i,r)),"strong"===t&&(i=n("b"),e=e.replace(i,r))}for(var a=/<(ul|ol)[^>]*>(?:(?!<ul|<ol)[\s\S])*?<\/\1>/gi;e.match(a);)e=e.replace(a,function(e){return e=e.replace(/<(ul|ol)[^>]*>([\s\S]*?)<\/\1>/gi,function(e,t,n){var r=n.split("</li>");r.pop();for(var i=0,o=r.length;o>i;i++){var a="ol"===t?i+1+". ":"* ";r[i]=a+r[i].replace(/\s*<li[^>]*>([\s\S]*)/i,function(e,t){return t=t.trim().replace(/\n/g,"\n  ")}).replace(/<[\/]?[\w]*[^>]*>/g,"")}return r.join("\n")}),log(e),"\n"+e.trim()});return e=e.replace(/<[\/]?[\w]*[^>]*>/g,"").replace(/```([\w\W]*)```/g,function(e,t){return t=t.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">"),"```"+t+"```"})}marked.setOptions({highlight:function(e,t){return Prism.highlight(e,Prism.languages[t])}}),e.ui.meditor="0.0.1",window.ME={version:e.ui.meditor,toolbar:{pipe:"",h1:"标题",bold:"粗体",italic:"斜体",through:"删除线",unordered:"无序列表",ordered:"有序列表",hr:"横线",time:"插入当前时间",face:"表情",table:"插入表格",image:"插入图片",file:"插入附件",inlinecode:"行内代码",blockcode:"代码块",preview:"预览",fullscreen:"全屏",about:"关于编辑器"},addon:{},insert:function(e,t){if(document.selection){e.focus();var n=document.selection.createRange();n.text=t,e.focus(),n.moveStart("character",-1)}else if(e.selectionStart||0===e.selectionStart){var r=e.selectionStart,i=e.selectionEnd,o=e.scrollTop;e.value=e.value.slice(0,r)+t+e.value.slice(i,e.value.length),e.selectionStart=r,e.selectionEnd=r+t.length,e.scrollTop=o,e.focus()}else e.value+=t,e.focus()},selection:function(e,t){if(document.selection)return document.selection.createRange().text;var n=e.selectionStart,r=e.selectionEnd;if(r){if(t){n=e.value.slice(0,n).lastIndexOf("\n");var i=e.value.slice(r).indexOf("\n");i=0>i?0:i,n+=1,r+=i,e.selectionStart=n,e.selectionEnd=r}}else t&&(r=e.value.indexOf("\n"),r=0>r?e.value.length:r,e.selectionEnd=r);return e.value.slice(n,r)},repeat:function(e,t){if(String.prototype.repeat)return e.repeat(t);for(var n="";t>0;)n+=e,t--;return n}};for(var i in e.modules)if(/meditor/.test(i)){ME.path=i.slice(0,i.lastIndexOf("/"));break}var o={p:function(e,t,n){return n?"\n"+n+"\n":""},br:"\n","h([1-6])":function(e,t,n,r){var i=ME.repeat("#",t);return"\n"+i+" "+r+"\n"},hr:"\n\n___\n\n",a:function(e,n,r){var i=n.match(t("href")),o=n.match(t("title")),a=n.match(t("target"));return i=i&&i[1]||"",o=o&&o[1]||"",a=a&&a[1]||"_self",i="javascript:void(0);"===i?"javascript:;":i,"["+(r||i)+"]("+i+' "title='+o+";target="+a+'")'},em:function(e,t,n){return n&&"_"+n+"_"||""},strong:function(e,t,n){return n&&"**"+n+"**"||""},code:function(e,t,n){return n&&"`"+n+"`"||""},pre:function(e,t,n){return"\n\n```\n"+n+"\n```\n"},blockquote:function(e,t,n){return"> "+n.trim()},img:function(e,n){var r=n.match(t("src")),i=n.match(t("alt"));return r=r&&r[1]||"",i=i&&i[1]||"","!["+i+"]("+r+")"}};require([ME.path+"/addon/base"],function(){function t(e){return e=(e+"").trim().toLowerCase(),e="|"===e?"pipe":e,'<span title="'+ME.toolbar[e]+'" class="edicon icon-'+e+'" '+("pipe"!==e?":click=\"$onToolbarClick('"+e+"')\"":"")+"></span>"}var n=["h1","quote","|","bold","italic","through","|","unordered","ordered","|","hr","link","time","face","|","table","image","file","inlinecode","blockcode","|","preview","fullscreen","|","about"],i=[];e.component("meditor",{$template:'<div class="do-meditor meditor-font" :class="{fullscreen: fullscreen}"><div class="tool-bar do-fn-noselect">{toolbar}</div><div class="editor-body"><textarea spellcheck="false" :duplex="plainTxt" :attr="{disabled: disabled}" :on-paste="$paste($event)" id="{uuid}"></textarea></div><div class="editor-md-preview" :visible="preview"><content class="preview" :html="htmlTxt"></content></div></div>',$$template:function(e){var r=(this.toolbar||n).map(function(e){return t(e)}).join("");return delete this.toolbar,e.replace(/\{uuid\}/g,this.$id).replace(/\{toolbar\}/g,r)},$construct:function(t,n,r){return e.mix(t,n,r),t.$addons&&Array.isArray(t.$addons)&&(i=t.$addons.map(function(e){return ME.path+"/addon/"+e}),delete t.$addons),t},$init:function(e){e.$watch("plainTxt",function(){e.$compile(),e.preview&&(e.htmlTxt=e.$htmlTxt),e.$onUpdate(e.plainTxt,e.$htmlTxt)}),e.$onToolbarClick=function(t){ME.addon[t]?ME.addon[t].call(ME.addon,this,e):console.log("%c没有对应的插件%c[%s]","color:#f00;","",t)}},$ready:function(t){t.$editor=document.querySelector("#"+t.$id),require(i,function(){var e=Array.prototype.slice.call(arguments,0);e.forEach(function(e){e&&e(t)})}),e(t.$editor).bind("keydown",function(e){if(9===e.keyCode){var n=ME.selection(t.$editor)||"";n=n.split("\n").map(function(t){return e.shiftKey?t.replace(/^\s\s/,""):"  "+t}).join("\n"),ME.insert(this,n),e.preventDefault()}})},$paste:function(e){var t=e.clipboardData.getData("text/plain").trim(),n=e.clipboardData.getData("text/html").trim();n=r(n),n?ME.insert(this,n):t&&ME.insert(this,t),e.preventDefault()},$compile:function(){this.$htmlTxt=marked(this.plainTxt.trim())},$onToolbarClick:e.noop,$onUpdate:e.noop,disabled:!1,fullscreen:!0,preview:!1,$editor:null,$htmlTxt:"",htmlTxt:"",plainTxt:""})})});