"use strict";var log=console.log;define(["yua","lib/prism/main","lib/marked","css!./skin/main"],function(e){function t(e){return new RegExp(e+"\\s?=\\s?[\"']?([^\"']*)[\"']?","i")}function n(e,t){var n="";return n=["br","hr","img"].indexOf(e)>-1?"<"+e+"([^>]*)\\/?>":"<"+e+"([^>]*)>([\\s\\S]*?)<\\/"+e+">",new RegExp(n,"gi")}function i(e){e=decodeURIComponent(e).replace(/\t/g,"    ").replace(/<meta [^>]*>/,"");for(var t in l){var i=l[t],r=n(t);if("blockquote"===t)for(;e.match(r);)e=e.replace(r,i);else e=e.replace(r,i);"em"===t&&(r=n("i"),e=e.replace(r,i)),"strong"===t&&(r=n("b"),e=e.replace(r,i))}for(var o=/<(ul|ol)[^>]*>(?:(?!<ul|<ol)[\s\S])*?<\/\1>/gi;e.match(o);)e=e.replace(o,function(e){return e=e.replace(/<(ul|ol)[^>]*>([\s\S]*?)<\/\1>/gi,function(e,t,n){var i=n.split("</li>");i.pop();for(var r=0,o=i.length;r<o;r++){var l="ol"===t?r+1+". ":"* ";i[r]=l+i[r].replace(/\s*<li[^>]*>([\s\S]*)/i,function(e,t){return t=t.trim().replace(/\n/g,"\n  ")}).replace(/<[\/]?[\w]*[^>]*>/g,"")}return i.join("\n")}),log(e),"\n"+e.trim()});return e=e.replace(/<[\/]?[\w]*[^>]*>/g,"").replace(/```([\w\W]*)```/g,function(e,t){return"```"+(t=t.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">"))+"```"})}marked.setOptions({highlight:function(e,t){return Prism.highlight(e,Prism.languages[t])}});var r=[];e.ui.meditor="0.0.1",window.ME={version:e.ui.meditor,toolbar:{pipe:"",h1:"标题",quote:"引用文本",bold:"粗体",italic:"斜体",through:"删除线",unordered:"无序列表",ordered:"有序列表",link:"超链接",hr:"横线",time:"插入当前时间",face:"表情",table:"插入表格",image:"插入图片",file:"插入附件",inlinecode:"行内代码",blockcode:"代码块",preview:"预览",fullscreen:"全屏",about:"关于编辑器"},addon:{},insert:function(e,t,n){if(document.selection){e.focus();var i=document.selection.createRange();i.text=t,e.focus(),i.moveStart("character",-1)}else if(e.selectionStart||0===e.selectionStart){var r=e.selectionStart,o=e.selectionEnd,l=e.scrollTop;e.value=e.value.slice(0,r)+t+e.value.slice(o,e.value.length),e.selectionStart=n?r:r+t.length,e.selectionEnd=r+t.length,e.scrollTop=l,e.focus()}else e.value+=t,e.focus()},selection:function(e,t){if(document.selection)return document.selection.createRange().text;var n=e.selectionStart,i=e.selectionEnd;if(i){if(t){n=e.value.slice(0,n).lastIndexOf("\n");var r=e.value.slice(i).indexOf("\n");n+=1,i+=r=r<0?0:r,e.selectionStart=n,e.selectionEnd=i}}else t&&(i=(i=e.value.indexOf("\n"))<0?e.value.length:i,e.selectionEnd=i);return e.value.slice(n,i)},repeat:function(e,t){if(String.prototype.repeat)return e.repeat(t);for(var n="";t>0;)n+=e,t--;return n},get:function(e){void 0===e&&(e=r.length-1);var t=r[e];return t?{id:t.$id,getVal:function(){return t.plainTxt.trim()},getHtml:function(){return t.$htmlTxt},setVal:function(e){t.plainTxt=e},show:function(){t.editorVisible=!0},hide:function(){t.editorVisible=!1}}:null}};for(var o in e.modules)if(/meditor/.test(o)){ME.path=o.slice(0,o.lastIndexOf("/"));break}var l={p:function(e,t,n){return n?"\n"+n+"\n":""},br:"\n","h([1-6])":function(e,t,n,i){return"\n"+ME.repeat("#",t)+" "+i+"\n"},hr:"\n\n___\n\n",a:function(e,n,i){var r=n.match(t("href")),o=n.match(t("title")),l=n.match(t("target"));return r=r&&r[1]||"",o=o&&o[1]||"",l=l&&l[1]||"_self",r="javascript:void(0);"===r?"javascript:;":r,"["+(i||r)+"]("+r+' "title='+o+";target="+l+'")'},em:function(e,t,n){return n&&"_"+n+"_"||""},strong:function(e,t,n){return n&&"**"+n+"**"||""},code:function(e,t,n){return n&&"`"+n+"`"||""},pre:function(e,t,n){return"\n\n```\n"+n+"\n```\n"},blockquote:function(e,t,n){return"> "+n.trim()},img:function(e,n,i){var r=n.match(t("src")),o=n.match(t("alt"));return r=r&&r[1]||"","!["+(o=o&&o[1]||"")+"]("+r+")"}};require([ME.path+"/addon/base"],function(){function t(e){return e=(e+"").trim().toLowerCase(),e="|"===e?"pipe":e,'<span title="'+ME.toolbar[e]+'" class="edicon icon-'+e+'" '+("pipe"!==e?":click=\"$onToolbarClick('"+e+"')\"":"")+"></span>"}var n=["h1","quote","|","bold","italic","through","|","unordered","ordered","|","hr","link","time","face","|","table","image","file","inlinecode","blockcode","|","preview","fullscreen","|","about"],o=[];e.component("meditor",{$template:'<div class="do-meditor meditor-font" :visible="editorVisible" :class="{fullscreen: fullscreen, preview: preview}"><div class="tool-bar do-fn-noselect">{toolbar}</div><div class="editor-body"><textarea spellcheck="false" :duplex="plainTxt" :attr="{disabled: disabled}" :on-paste="$paste($event)" id="{uuid}"></textarea></div><content class="md-preview" :visible="preview" :html="htmlTxt"></content></div>',$$template:function(e){var i=(this.toolbar||n).map(function(e){return t(e)}).join("");return delete this.toolbar,e.replace(/\{uuid\}/g,this.$id).replace(/\{toolbar\}/g,i)},$construct:function(t,n,i){return e.mix(t,n,i),t.$addons&&Array.isArray(t.$addons)&&(o=t.$addons.map(function(e){return ME.path+"/addon/"+e}),delete t.$addons),t.hasOwnProperty("$show")&&(t.editorVisible=t.$show,delete t.$show),t},$init:function(e){e.$watch("plainTxt",function(t){e.$compile(),e.preview&&(e.htmlTxt=e.$htmlTxt),e.$onUpdate(e.plainTxt,e.$htmlTxt)}),e.$onToolbarClick=function(t){ME.addon[t]?ME.addon[t].call(ME.addon,this,e):console.log("%c没有对应的插件%c[%s]","color:#f00;","",t)}},$ready:function(t){t.$editor=document.querySelector("#"+t.$id),r.push(t),require(o,function(){Array.prototype.slice.call(arguments,0).forEach(function(e){e&&e(t)})}),e(t.$editor).bind("keydown",function(e){var n=ME.selection(t.$editor)||"",i=!!n;9===e.keyCode&&(n=n.split("\n").map(function(t){return e.shiftKey?t.replace(/^\s\s/,""):"  "+t}).join("\n"),ME.insert(this,n,i),e.preventDefault()),8===e.keyCode&&i&&(ME.insert(this,"",i),e.preventDefault())}),t.$onSuccess(ME.get(),t)},$paste:function(e){var t=e.clipboardData.getData("text/plain").trim(),n=e.clipboardData.getData("text/html").trim();(n=i(n))?ME.insert(this,n):t&&ME.insert(this,t),e.preventDefault()},$compile:function(){var e=this.plainTxt.trim();e=e.replace(/<script>/g,"&lt;script&gt;").replace(/<\/script>/g,"&lt;/script&gt;"),this.$htmlTxt=marked(e)},$onToolbarClick:e.noop,$onSuccess:e.noop,$onUpdate:e.noop,$onFullscreen:e.noop,disabled:!1,fullscreen:!1,preview:!1,$editor:null,editorVisible:!0,$htmlTxt:"",htmlTxt:"",plainTxt:""})})});