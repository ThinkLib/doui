define(["yua"],function(){function t(){this.table={get:[]},this.errorFn=null,this.history=null,this.hash="",this.started=!1,this.init={}}function r(t){return!t||t===window.name||"_self"===t||"top"===t&&window==window.top}var e={prefix:/^(#!|#)[\/]?/,historyOpen:!0,allowReload:!0},i=!0;return t.prototype={error:function(t){this.errorFn=t},config:function(t){if(this.started)return console.error("Router config has been set");this.started=!0,t.allowReload||(t.historyOpen=!0),this.init=yua.mix({},e,t)},_getRegExp:function(t,r){var e=t.replace(/(:id)|(\{id\})|(\{id:([A-z\d\,\[\]\{\}\-\+\*\?\!:\^\$]*)\})/g,function(t,r,e,i,a){var n="([\\w.-]";return r||e?n+"+)":(/^\{[\d\,]+\}$/.test(a)||(n="("),n+a+")")});return e=e.replace(/(([^\\])([\/]+))/g,"$2\\/").replace(/(([^\\])([\.]+))/g,"$2\\.").replace(/(([^\\])([\-]+))/g,"$2\\-").replace(/(\(.*)(\\[\-]+)(.*\))/g,"$1-$3"),e="^"+e+"$",r.regexp=new RegExp(e),r},_add:function(t,r,e){this.started||this.config({});var i=this.table[t.toLowerCase()];if("/"!==r.charAt(0))return void console.error('char "/" must be in front of router rule');r=r.replace(/^[\/]+|[\/]+$|\s+/g,"");var a={};a.rule=r,a.callback=e,yua.Array.ensure(i,this._getRegExp(r,a))},_route:function(t,r){var r=r.trim(),e=this.table[t],i=this.init;if(i.allowReload||r!==this.history){i.historyOpen&&(this.history=r,yua.ls&&yua.ls("lastHash",r));for(var a,n=0;a=e[n++];){var o=r.match(a.regexp);if(o)return o.shift(),a.callback.apply(a,o)}this.errorFn&&this.errorFn(r)}},on:function(t,r){var e=this;Array.isArray(t)?t.forEach(function(t){e._add("get",t,r)}):this._add("get",t,r)}},yua.bind(window,"load",function(){if(yua.router.started){var t=yua.router.init.prefix,r=location.hash;r=r.replace(t,"").trim(),yua.router._route("get",r)}}),"onhashchange"in window&&window.addEventListener("hashchange",function(t){if(i){var r=yua.router.init.prefix,e=location.hash.replace(r,"").trim();yua.router._route("get",e)}}),yua.bind(document,"mousedown",function(t){if(!(("defaultPrevented"in t?t.defaultPrevented:!1===t.returnValue)||t.ctrlKey||t.metaKey||2===t.which)){for(var e=t.target;"A"!==e.nodeName;)if(!(e=e.parentNode)||"BODY"===e.tagName)return;if(r(e.target)){if(!yua.router.started)return;var a=e.getAttribute("href")||e.getAttribute("xlink:href"),n=yua.router.init.prefix;if(null===a||!n.test(a))return;yua.router.hash=a.replace(n,"").trim(),t.preventDefault(),location.hash=a,i=!1}}}),yua.bind(document,"mouseup",function(){i||(yua.router._route("get",yua.router.hash),i=!0)}),yua.ui.router="0.0.1",yua.router=new t});